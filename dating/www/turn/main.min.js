"use strict"; function getEssential(e) { var n, o = /([^&=]+)=?([^&]*)/g; for (sessionStorage.clear() ; n = o.exec(e.search.slice(1)) ;) sessionStorage.setItem(n[1], decodeURIComponent(n[2])) } function clone(e) { var n = JSON.stringify(e); return JSON.parse(n) } function ajax(e) { return new Promise(function (n, o) { var t = new XMLHttpRequest; t.onload = function () { var e; this.status >= 200 && this.status < 300 ? (e = this.response.replace(/'/g, '"'), n(JSON.parse(e))) : o("XHR status error") }, t.onerror = function () { o("XHR error") }, t.open("GET", e, !0), t.send() }) } function buildAPI(e, n) { var o = [], t = Object.keys(n); return t.forEach(function (e) { o.push(encodeURIComponent(e) + "=" + encodeURIComponent(n[e])) }), e + "?" + o.join("&") } function setUserInfo() { User.groupid = Number(window.sessionStorage.getItem("groupid")), User.user = Number(window.sessionStorage.getItem("user")), User.sessionId = window.sessionStorage.getItem("sessionId"), User.pwd = window.sessionStorage.getItem("pwd"), console.log(User), console.log(Base) } function handler(e) { var n = e.target.dataset.trigger; switch (n) { case "once": handleGame(e, !1); break; case "all": handleGame(e, !0); break; case "close": handleClose(e) } e.preventDefault(), e.stopPropagation() } function handleGame(e, n) { var o, t = Base.url; Ctrl.loading || (Ctrl.loading = !0, document.querySelector("#prompt .close").click(), document.querySelector("#prompt--error .close").click(), o = clone(User), o.flag = n ? 1 : 0, t += buildAPI("hit", o), console.log(t), ajax(t).then(function (e) { 0 === e.ResponseCode ? dataMain(e, n) : dataError(e.ResponseCode) })["catch"](function (e) { console.log(e) })) } function handleClose(e) { var n = e.target.dataset.target, o = document.querySelector(n); o.classList.add("hidden"), [].forEach.call(o.querySelectorAll(".val"), function (e) { e.innerHTML = "" }) } function setPool() { var e = { user: User.user, sessionId: User.sessionId }, n = Base.url + buildAPI("info", e); ajax(n).then(function (e) { dataPool(e) })["catch"](function (e) { console.log(e) }) } function setRank() { var e = Base.url + "winner", n = Base.url + "topprize"; ajax(e).then(function (e) { dataRank(!0, e) })["catch"](function (e) { console.log(e) }), ajax(n).then(function (e) { dataRank(!1, e) })["catch"](function (e) { console.log(e) }) } function dataPool(e) { var n, o, t = document.querySelector("#zhizhen p"), a = document.querySelector("#pool ul"), r = a.querySelectorAll("li"), s = e.prizepool; t.innerHTML = e.num, [].forEach.call(r, function (e) { e.className = "" }); for (var l = 9; l > 0; l--) o = "num__0", s / 10 > 0 && (n = s % 10, s = Math.floor(s / 10), o = "num__" + n), a.querySelector("li:nth-child(" + l + ")").classList.add(o) } function dataRank(e, n) { var o = e ? "#winner" : "#topprize", t = document.querySelector(o), a = "<li><span>{{name}}</span><span>{{idx}}</span><!--\n    --><span>{{winning}}</span><span>{{date}}</span></li>", r = "<li><span>{{date}}</span><span>{{name}}</span><!--\n    --><span>{{idx}}</span><span>{{winning}}</span></li>", s = e ? a : r, l = ""; n.forEach(function (e) { var n = s; n = n.replace("{{name}}", e.username), n = n.replace("{{idx}}", e.userid), n = n.replace("{{winning}}", e.winning), n = n.replace("{{date}}", e.date), l += n }), t.innerHTML = "", t.insertAdjacentHTML("afterbegin", l) } function dataMain(e, n) { var o, t, a, r = document.querySelector("#zhuanpan"), s = document.querySelector("#prompt"), l = n ? "prompt--all" : "prompt--once", i = 0; if (n) { for (var c = 0; c < 7; c++) a = e["winstyle0" + c], i += a, s.querySelector(".body--all .val--" + (c + 1)).innerHTML = a, a > 0 && (o = "rotate--" + (c + 1), t = "angle--" + (c + 1)); s.querySelector(".body--all .count").innerHTML = i, s.querySelector(".body--all .earn").innerHTML = e.getcoin } else o = "rotate--" + (e.winstyle00 + 1), t = "angle--" + (e.winstyle00 + 1), s.querySelector(".body--once .earn").innerHTML = e.getcoin; Ctrl.hold = t, r.className = "", r.classList.add(o), r.addEventListener("webkitAnimationEnd", handleEnd, !1), s.classList.remove("prompt--all", "prompt--once"), s.classList.add(l), Ctrl.prizepool = e.poolnum, Ctrl.num = e.lottery } function dataError(e) { var n, o = document.querySelector("#prompt--error"); switch (Ctrl.loading = !1, console.log(e), e) { case -2097135487: n = "抽奖次数不足"; break; case -2097135486: n = "奖池数不足500"; break; case -3: n = "抽奖失败"; break; case -2: n = "身份验证失败"; break; case -1: n = "登录过期，请重新登录"; break; default: n = "抽奖失败，请重试" } o.querySelector(".val").innerHTML = n, o.classList.remove("hidden") } function handleEnd(e) { var n = document.querySelector("#prompt"), o = { prizepool: Ctrl.prizepool, num: Ctrl.num }; Ctrl.loading = !1, n.classList.remove("hidden"), e.target.className = "", e.target.classList.add(Ctrl.hold), dataPool(o), setRank() } var Base = { url: "" }, User = { groupid: 0, user: 0, sessionId: "", pwd: "" }, Ctrl = { loading: !1, hold: "", prizepool: 0, num: 0 }; document.addEventListener("DOMContentLoaded", function () { getEssential(window.location), setUserInfo(), document.body.addEventListener("click", handler, !0) }), window.addEventListener("load", function () { setPool(), setRank() }, !1);